generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  TRIAL
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  AWAITING_VALIDATION
  COMPLETED
  FAILED
  REFUNDED
}

enum ProductOrderStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum ExpertRole {
  EXPERT
  ADMIN
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
  REVISION_NEEDED
}

enum ValidationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AudioVoice {
  MASCULINE
  FEMININE
}

enum DeliveryFormat {
  EMAIL
  WHATSAPP
}

enum FileType {
  FACE_PHOTO
  PALM_PHOTO
}

enum ProductLevel {
  INITIE
  MYSTIQUE
  PROFOND
  INTEGRALE
}

enum PathActionType {
  MANTRA
  RITUAL
  JOURNALING
  MEDITATION
  REFLECTION
}

model User {
  id                 String             @id @default(cuid())
  email              String             @unique
  firstName          String
  lastName           String
  phone              String?
  dateOfBirth        DateTime?
  stripeCustomerId   String?            @unique
  subscriptionStatus SubscriptionStatus @default(INACTIVE)
  totalOrders        Int                @default(0)
  lastOrderAt        DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  profile       UserProfile?
  orders        Order[]
  spiritualPath SpiritualPath?
  chatSessions  ChatSession[]

  @@index([email])
  @@index([createdAt(sort: Desc)])
}

model UserProfile {
  id               String    @id @default(cuid())
  userId           String    @unique
  user             User      @relation(fields: [userId], references: [id])
  birthDate        String?
  birthTime        String?
  birthPlace       String?
  specificQuestion String?   @db.Text
  objective        String?   @db.Text
  facePhotoUrl     String?
  palmPhotoUrl     String?
  highs            String?   @db.Text
  lows             String?   @db.Text
  strongSide       String?
  weakSide         String?
  strongZone       String?
  weakZone         String?
  deliveryStyle    String?
  pace             Int?
  ailments         String?   @db.Text
  fears            String?   @db.Text
  rituals          String?   @db.Text
  profileCompleted Boolean   @default(false)
  submittedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

model Order {
  id                 String         @id @default(cuid())
  orderNumber        String         @unique
  userId             String
  user               User           @relation(fields: [userId], references: [id])
  userEmail          String
  userName           String?
  level              Int
  amount             Int
  currency           String         @default("eur")
  status             OrderStatus    @default(PENDING)
  paymentIntentId    String?
  stripeSessionId    String?
  paidAt             DateTime?
  formData           Json
  clientInputs       Json?
  expertPrompt       String?        @db.Text
  expertInstructions String?        @db.Text
  generatedContent   Json?
  errorLog           String?        @db.Text
  expertReview       Json?
  expertValidation   Json?
  revisionCount      Int            @default(0)
  deliveredAt        DateTime?
  deliveryMethod     DeliveryFormat?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  // Relations for interconnected ecosystem
  files          OrderFile[]
  generatedSteps PathStep[]     // Steps generated from this reading
  chatContexts   ChatSession[]  // Chat sessions related to this order

  @@index([userId])
  @@index([userEmail])
  @@index([status])
  @@index([level])
  @@index([createdAt(sort: Desc)])
  @@index([paymentIntentId])
}

model OrderFile {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  name        String
  url         String
  key         String
  contentType String
  size        Int
  type        FileType
  uploadedAt  DateTime @default(now())

  @@index([orderId])
}

model ProductOrder {
  id              String             @id @default(cuid())
  productId       String
  customerId      String?
  customerEmail   String?
  amount          Int
  currency        String             @default("eur")
  status          ProductOrderStatus @default(PENDING)
  paymentIntentId String             @unique
  completedAt     DateTime?
  metadata        Json?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([productId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
}

model Expert {
  id        String     @id @default(cuid())
  email     String     @unique
  password  String
  name      String
  role      ExpertRole @default(EXPERT)
  isActive  Boolean    @default(true)
  lastLogin DateTime?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([isActive])
  @@index([createdAt(sort: Desc)])
}

model ProcessedEvent {
  id          String   @id @default(cuid())
  eventId     String   @unique
  eventType   String
  processedAt DateTime @default(now())
  data        Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([eventId])
}

model Product {
  id           String       @id
  name         String
  description  String
  amountCents  Int
  currency     String       @default("eur")
  level        ProductLevel
  features     String[]
  limitedOffer String?
  isActive     Boolean      @default(true)
  comingSoon   Boolean      @default(false)
  metadata     Json?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
}

// =============================================================================
// INSIGHTS - AI-Generated Spiritual Insights
// =============================================================================

enum InsightCategory {
  SPIRITUEL
  RELATIONS
  MISSION
  CREATIVITE
  EMOTIONS
  TRAVAIL
  SANTE
  FINANCE
}

model Insight {
  id          String          @id @default(cuid())
  userId      String
  orderId     String?
  category    InsightCategory
  short       String          @db.Text    // Résumé court (2-3 phrases)
  full        String          @db.Text    // Texte complet (1-2 paragraphes)
  viewedAt    DateTime?                   // Null = "Nouveau" badge
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([userId, category])  // Un seul insight par catégorie par user
  @@index([userId])
  @@index([orderId])
}

// =============================================================================
// DIGITAL SOUL - Spiritual Path & Journey
// =============================================================================

model SpiritualPath {
  id          String    @id @default(cuid())
  userId      String    @unique
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  archetype   String                    // e.g., "Le Guérisseur", "Le Visionnaire"
  synthesis   String    @db.Text        // AI-generated synthesis of the user's spiritual journey
  keyBlockage String?                   // Primary spiritual blockage identified
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  steps       PathStep[]

  @@index([userId])
  @@index([archetype])
}

model PathStep {
  id              String         @id @default(cuid())
  spiritualPathId String
  spiritualPath   SpiritualPath  @relation(fields: [spiritualPathId], references: [id], onDelete: Cascade)
  dayNumber       Int                        // Day in the journey (1-30, etc.)
  title           String                     // Step title
  description     String         @db.Text    // Detailed description of this step
  synthesis       String         @db.Text    // AI-generated content for this step
  archetype       String                     // Archetype theme for this step
  actionType      PathActionType @default(REFLECTION) // Type of action required
  ritualPrompt    String?        @db.Text    // Optional ritual/meditation prompt
  isCompleted     Boolean        @default(false)
  completedAt     DateTime?
  unlockedAt      DateTime?                  // When this step became available
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Link back to the reading that generated this step
  originReadingId String?
  originReading   Order?         @relation(fields: [originReadingId], references: [id], onDelete: SetNull)

  @@unique([spiritualPathId, dayNumber])
  @@index([spiritualPathId])
  @@index([dayNumber])
  @@index([isCompleted])
  @@index([originReadingId])
}

// =============================================================================
// CHAT - Conversational AI Sessions
// =============================================================================

model ChatSession {
  id             String    @id @default(cuid())
  userId         String
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  relatedOrderId String?                  // Optional link to a specific reading
  relatedOrder   Order?    @relation(fields: [relatedOrderId], references: [id], onDelete: SetNull)
  title          String?                  // Auto-generated session title
  messages       Json      @default("[]") // Array of {role, content, timestamp}
  isActive       Boolean   @default(true)
  lastMessageAt  DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([userId])
  @@index([relatedOrderId])
  @@index([isActive])
  @@index([lastMessageAt(sort: Desc)])
}

// =============================================================================
// SYSTEM SETTINGS - Dynamic Configuration
// =============================================================================

model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   @db.Text
  isEncrypted Boolean  @default(false)
  updatedAt   DateTime @updatedAt
}
